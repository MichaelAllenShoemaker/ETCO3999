#include "neslib.h"
#include "vrambuf.h"
#include "bcd.h"
// link the pattern table into CHR ROM
//#link "chr_generic.s"
//#link "vrambuf.c"
#define NES_MIRRORING 1 ("vertical", 0 = "horizontal")

/*{pal:"nes",layout:"nes"}*/
const char PALETTE[32] =
{
  0x0F, // screen color
  
  0x0F, 0x30, 0x28, 0x00, // background palette 0
  0x16, 0x20, 0x2C, 0x00, // background palette 1
  0x00, 0x1A, 0x20, 0x00, // background palette 2
  0x00, 0x1A, 0x20, 0x00, // background palette 3
  
  0x07, 0x27, 0x1C, 0x00, // sprite palette 0
  0x00, 0x37, 0x25, 0x00, // sprite palette 1
  0x36, 0x21, 0x19, 0x00, // sprite palette 2
  0x1D, 0x37, 0x2B, // sprite palette 3
};

///// METASPRITES
#define TILE 0xd8
// define a 2x2 metasprite
unsigned char rightPlayer[]={
        0,      0,      TILE+0,   0x00, 
        0,      8,      TILE+1,   0x00, 
        8,      0,      TILE+2,   0x00, 
        8,      8,      TILE+3,   0x00, 
        128};

unsigned char leftPlayer[]={
        0,      0,      TILE+2,   0x40, 
        0,      8,      TILE+3,   0x40, 
        8,      0,      TILE+0,   0x40, 
        8,      8,      TILE+1,   0x40, 
        128};

const unsigned char leftMap[270]={
0x02,0xc0,0x02,0x0e,0xc4,0xc6,0xc0,0x02,0x1d,0xc5,0xc7,0xc0,0x02,0x0f,0x8f,0x02,
0x0c,0x01,0x8f,0x8f,0x01,0x8f,0x02,0x0d,0xc0,0x8f,0x02,0x0c,0x01,0x8f,0x8f,0x01,
0x8f,0x02,0x0d,0xc0,0x8f,0x02,0x0c,0x01,0x8f,0x8f,0x01,0x8f,0x02,0x0d,0xc0,0x8f,
0x02,0x0c,0x01,0x8f,0x8f,0x01,0x8f,0x02,0x0d,0xc0,0x8f,0x02,0x0c,0x01,0x8f,0x8f,
0x01,0x8f,0x02,0x0d,0xc0,0x8f,0x02,0x0c,0x01,0x8f,0x8f,0x01,0x01,0x8f,0x02,0x0c,
0xc0,0x8f,0x02,0x0c,0x01,0x8f,0x02,0x02,0x01,0x8f,0x02,0x0c,0xc0,0x8f,0x02,0x0c,
0x01,0x8f,0x02,0x02,0x01,0x8f,0x02,0x0c,0xc0,0x8f,0x02,0x0c,0x01,0x8f,0x8f,0x01,
0x01,0x8f,0x02,0x0c,0xc0,0x8f,0x02,0x0c,0x01,0x8f,0x8f,0x01,0x8f,0x02,0x0d,0xc0,
0x8f,0x02,0x0c,0x01,0x8f,0x8f,0x01,0x8f,0x02,0x0d,0xc0,0x8f,0x02,0x0c,0x01,0x8f,
0x01,0x02,0x09,0xf4,0xa0,0x02,0x02,0xf6,0x8f,0xc0,0x8f,0x02,0x0c,0x01,0x8f,0x8f,
0x01,0x8f,0x02,0x07,0xa2,0x00,0x02,0x02,0xa3,0x8f,0xc0,0x8f,0x02,0x0c,0x01,0x8f,
0x8f,0x01,0x8f,0x02,0x07,0xa2,0x00,0x02,0x02,0xa3,0x8f,0xc0,0x8f,0x02,0x0c,0x01,
0x8f,0x8f,0x01,0x8f,0x02,0x07,0xa2,0x00,0x02,0x02,0xa3,0x8f,0xc0,0x8f,0x02,0x0c,
0x01,0x8f,0x8f,0x01,0x8f,0x02,0x07,0xf5,0xa1,0x02,0x02,0xf7,0x8f,0xc0,0x8f,0x02,
0x0c,0x01,0x8f,0x8f,0x01,0x8f,0x02,0x0d,0xc0,0x8f,0x02,0x0c,0x01,0x8f,0x8f,0x01,
0x8f,0x02,0x0d,0xc0,0x8f,0x02,0x0c,0x01,0x8f,0x8f,0x01,0x8f,0x02,0x0d,0xc0,0x8f,
0x02,0x0c,0x01,0x02,0x03,0x8f,0x02,0x0d,0xc0,0x02,0x3e,0xc0,0x02,0x00
};

const unsigned char rightMap[300]={
0x02,0xc0,0x02,0x0e,0xc4,0xc6,0xc0,0x02,0x1d,0xc5,0xc7,0xc0,0x02,0x0e,0x01,0x8f,
0x02,0x0c,0x01,0x8f,0x8f,0x01,0x8f,0x02,0x0c,0xc0,0x01,0x8f,0x02,0x0c,0x01,0x8f,
0x8f,0x01,0x8f,0x02,0x0c,0xc0,0x01,0x8f,0x02,0x0c,0x01,0x8f,0x8f,0x01,0x8f,0x02,
0x0c,0xc0,0x01,0x8f,0x02,0x0c,0x01,0x8f,0x8f,0x01,0x8f,0x02,0x0c,0xc0,0x01,0x8f,
0x02,0x0c,0x01,0x8f,0x8f,0x01,0x8f,0x02,0x0c,0xc0,0x01,0x8f,0x02,0x0c,0x01,0x8f,
0x8f,0x01,0x01,0x8f,0x02,0x0b,0xc0,0x01,0x8f,0x02,0x0c,0x01,0x8f,0x02,0x02,0x01,
0x8f,0x02,0x0b,0xc0,0x01,0x8f,0x02,0x0c,0x01,0x8f,0x02,0x02,0x01,0x8f,0x02,0x0b,
0xc0,0x01,0x8f,0x02,0x0c,0x01,0x8f,0x8f,0x01,0x01,0x8f,0x02,0x0b,0xc0,0x01,0x8f,
0x02,0x0c,0x01,0x8f,0x8f,0x01,0x8f,0x02,0x0c,0xc0,0x01,0x01,0x8f,0x02,0x0b,0x01,
0x8f,0x8f,0x01,0x8f,0x02,0x0c,0xc0,0x01,0xf4,0xa0,0x02,0x02,0xf6,0x8f,0x02,0x07,
0x01,0x8f,0x01,0x02,0x0e,0xc0,0x01,0xa2,0x00,0x02,0x02,0xa3,0x8f,0x02,0x07,0x01,
0x8f,0x8f,0x01,0x8f,0x02,0x07,0x01,0x02,0x04,0xc0,0x01,0xa2,0x00,0x02,0x02,0xa3,
0x8f,0x02,0x07,0x01,0x8f,0x8f,0x01,0x8f,0x02,0x07,0x01,0x02,0x04,0xc0,0x01,0xa2,
0x00,0x02,0x02,0xa3,0x8f,0x02,0x07,0x01,0x8f,0x8f,0x01,0x8f,0x02,0x07,0x01,0x02,
0x04,0xc0,0x01,0xf5,0xa1,0x02,0x02,0xf7,0x8f,0x02,0x07,0x01,0x8f,0x8f,0x01,0x8f,
0x02,0x07,0x01,0x02,0x04,0xc0,0x01,0x02,0x05,0x8f,0x02,0x07,0x01,0x8f,0x8f,0x01,
0x8f,0x02,0x0c,0xc0,0x01,0x8f,0x02,0x0c,0x01,0x8f,0x8f,0x01,0x8f,0x02,0x0c,0xc0,
0x01,0x8f,0x02,0x0c,0x01,0x8f,0x8f,0x01,0x8f,0x02,0x0c,0xc0,0x01,0x8f,0x02,0x0c,
0x01,0x02,0x03,0x8f,0x02,0x0c,0xc0,0x02,0x3f,0xc0,0x02,0x00
};
unsigned char cam_x = 1;


// main function, run after console reset
void main(void) 
{
  
  // character position
  unsigned char player_x = 128;
  unsigned char player_y = 55;
  
  //int for direction 0 = right, 1 = down, 2 = left, 3 = up
  int playerDirection = 0;
  
  
  // sprite atribute
  char atri = 0x00;
  
  vram_adr(NTADR_A(1, 4)); // Zelda probably started at 0x28d0 (8 rows below stats area)
  vram_unrle(leftMap); // my map01 is an array of 274 unsigned char's
  
  vram_adr(NTADR_B(0,4)); // Zelda probably started at 0x28d0 (8 rows below stats area)
  vram_unrle(rightMap); // my map01 is an array of 274 unsigned char's
  
  // enable PPU rendering (turn on screen)
  ppu_on_all();
  pal_all(PALETTE); // generally before game loop (in main)
  
  vrambuf_clear();
  set_vram_update(updbuf); // updbuf = 0x100 -- start of stack RAM

  //move the camera into place before the player starts
  scroll(0, 0);
  
  // game loop
  while (1)
  {
    // do this at the start of each frame
    int oam_id = 0;
    
    // getting player input
    char pad_result = pad_poll(0); 
    
    //moving the player
    if((pad_result >> 7) & 0x01)
    {
      // moving to the right
      if(cam_x + 1 < 256 && player_x > 128)
      {
        scroll(cam_x++, 0);
      }
      else
      {
        if(player_x+1 < 230)
          player_x += 1;
      }
      playerDirection = 0;
    }
    
    else if((pad_result >> 6) & 0x01)
    {
      //moving to the left
      if(cam_x - 1 > 1 && player_x < 128)
      {
        scroll(cam_x--, 0);
      }
      else
      {
        if(player_x-1 > 12)
          player_x -= 1;
      }
      playerDirection = 2;
    }
    else if((pad_result >> 4) & 0x01)
    {
      //moving up
      if(player_y-1 > 42)
      	player_y -= 1;
      playerDirection = 1;
    }
    else if((pad_result >> 5) & 0x01)
    {
      //moving down
      if(player_y+1 < 192)
      	player_y += 1;
      playerDirection = 3;
    }
    
    if(playerDirection == 0)
    	oam_id = oam_meta_spr(player_x, player_y, oam_id, rightPlayer);
    else
      	oam_id = oam_meta_spr(player_x, player_y, oam_id, leftPlayer);
    
    vrambuf_flush();
    // Do this to "hide" any remaining sprites
    oam_hide_rest(oam_id);
  }
}
